<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>nfs-ganesha: nfs_dupreq.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">nfs-ganesha&#160;<span id="projectnumber">1.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>nfs_dupreq.c</h1>  </div>
</div>
<div class="contents">
<a href="nfs__dupreq_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * vim:expandtab:shiftwidth=8:tabstop=8:</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright CEA/DAM/DIF  (2008)</span>
<a name="l00005"></a>00005 <span class="comment"> * contributeur : Philippe DENIEL   philippe.deniel@cea.fr</span>
<a name="l00006"></a>00006 <span class="comment"> *                Thomas LEIBOVICI  thomas.leibovici@cea.fr</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00009"></a>00009 <span class="comment"> * modify it under the terms of the GNU Lesser General Public License</span>
<a name="l00010"></a>00010 <span class="comment"> * as published by the Free Software Foundation; either version 3 of</span>
<a name="l00011"></a>00011 <span class="comment"> * the License, or (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * This program is distributed in the hope that it will be useful, but</span>
<a name="l00014"></a>00014 <span class="comment"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00015"></a>00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<a name="l00016"></a>00016 <span class="comment"> * Lesser General Public License for more details.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
<a name="l00019"></a>00019 <span class="comment"> * License along with this library; if not, write to the Free Software</span>
<a name="l00020"></a>00020 <span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<a name="l00021"></a>00021 <span class="comment"> * 02110-1301 USA</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ---------------------------------------</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00034"></a>00034 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#endif</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>
<a name="l00038"></a>00038 <span class="preprocessor">#ifdef _SOLARIS</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#include &quot;solaris_port.h&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#endif</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;ctype.h&gt;</span>              <span class="comment">/* for having isalnum */</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>             <span class="comment">/* for having atoi */</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;dirent.h&gt;</span>             <span class="comment">/* for having MAXNAMLEN */</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>           <span class="comment">/* for having FNDELAY */</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;grp.h&gt;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="rpcal_8h.html">rpcal.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;LRU_List.h&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;HashData.h&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;HashTable.h&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;log.h&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;nfs_core.h&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;nfs23.h&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;nfs4.h&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;fsal.h&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;nfs_tools.h&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;nfs_exports.h&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;nfs_file_handle.h&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;nfs_dupreq.h&quot;</span>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="keyword">extern</span> <a class="code" href="structnfs__function__desc____.html">nfs_function_desc_t</a> <a class="code" href="nfs__worker__thread_8c.html#ae9ae682ddad7174791232905d02ec256">nfs2_func_desc</a>[];
<a name="l00072"></a>00072 <span class="keyword">extern</span> <a class="code" href="structnfs__function__desc____.html">nfs_function_desc_t</a> <a class="code" href="nfs__worker__thread_8c.html#a580a0054fa9c0c4e06806571159dcd53">nfs3_func_desc</a>[];
<a name="l00073"></a>00073 <span class="keyword">extern</span> <a class="code" href="structnfs__function__desc____.html">nfs_function_desc_t</a> <a class="code" href="nfs__worker__thread_8c.html#af71589ae240e6becde81cba53f437acc">nfs4_func_desc</a>[];
<a name="l00074"></a>00074 <span class="keyword">extern</span> <a class="code" href="structnfs__function__desc____.html">nfs_function_desc_t</a> <a class="code" href="nfs__worker__thread_8c.html#ab439a33fe7152078b400f13678c012f1">mnt1_func_desc</a>[];
<a name="l00075"></a>00075 <span class="keyword">extern</span> <a class="code" href="structnfs__function__desc____.html">nfs_function_desc_t</a> <a class="code" href="nfs__worker__thread_8c.html#a41035b6c8b713eb089640889054745f0">mnt3_func_desc</a>[];
<a name="l00076"></a>00076 <span class="preprocessor">#ifdef _USE_NLM</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="keyword">extern</span> <a class="code" href="structnfs__function__desc____.html">nfs_function_desc_t</a> nlm4_func_desc[];
<a name="l00078"></a>00078 <span class="preprocessor">#endif                          </span><span class="comment">/* _USE_NLM */</span>
<a name="l00079"></a>00079 <span class="preprocessor">#ifdef _USE_RQUOTA</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span><span class="keyword">extern</span> <a class="code" href="structnfs__function__desc____.html">nfs_function_desc_t</a> rquota1_func_desc[];
<a name="l00081"></a>00081 <span class="keyword">extern</span> <a class="code" href="structnfs__function__desc____.html">nfs_function_desc_t</a> rquota2_func_desc[];
<a name="l00082"></a>00082 <span class="preprocessor">#endif                          </span><span class="comment">/* _USE_QUOTA */</span>
<a name="l00083"></a>00083 <span class="comment">/* Structure used for duplicated request cache */</span>
<a name="l00084"></a><a class="code" href="nfs__dupreq_8c.html#ab41dfb8f9862268dfce85547de3d5ee9">00084</a> <a class="code" href="structhash__table.html">hash_table_t</a> *<a class="code" href="nfs__dupreq_8c.html#ab41dfb8f9862268dfce85547de3d5ee9">ht_dupreq_udp</a>;
<a name="l00085"></a><a class="code" href="nfs__dupreq_8c.html#a6886caab6efa0f98e18c1fc2b2bec54b">00085</a> <a class="code" href="structhash__table.html">hash_table_t</a> *<a class="code" href="nfs__dupreq_8c.html#a6886caab6efa0f98e18c1fc2b2bec54b">ht_dupreq_tcp</a>;
<a name="l00086"></a>00086 
<a name="l00087"></a><a class="code" href="nfs__dupreq_8c.html#a19a92c1cca2c6d33998dddd4094eef7f">00087</a> <span class="keywordtype">void</span> <a class="code" href="nfs__dupreq_8c.html#a19a92c1cca2c6d33998dddd4094eef7f">LogDupReq</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *label, <a class="code" href="ganesha__rpc_8h.html#a42f3261a45141da24a6d18194eae1c91">sockaddr_t</a> *addr, <span class="keywordtype">long</span> xid, u_long rq_prog)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089   <span class="keywordtype">char</span> namebuf[<a class="code" href="ganesha__rpc_8h.html#a9174d973fdbe2abdc1987d702b5b7d1a">SOCK_NAME_MAX</a>];
<a name="l00090"></a>00090 
<a name="l00091"></a>00091   <a class="code" href="ganesha__rpc_8h.html#a798e3040dc5734e965e36b405958f984">sprint_sockaddr</a>(addr, namebuf, <span class="keyword">sizeof</span>(namebuf));
<a name="l00092"></a>00092 
<a name="l00093"></a>00093   <a class="code" href="log_8h.html#a8ca2131f27bca0bd0e870c3c2da64cb1">LogFullDebug</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556ab22e11ab2329da5c014538bee4066181">COMPONENT_DUPREQ</a>,
<a name="l00094"></a>00094                <span class="stringliteral">&quot;%s addr=%s xid=%ld rq_prog=%ld&quot;</span>,
<a name="l00095"></a>00095                label, namebuf, xid, rq_prog);
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> get_ipproto_by_xprt( SVCXPRT * xprt )
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100    <span class="keywordflow">if</span>( xprt-&gt;xp_p2 != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> )
<a name="l00101"></a>00101      <span class="keywordflow">return</span> IPPROTO_UDP ;
<a name="l00102"></a>00102    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( xprt-&gt;xp_p1 != <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> )
<a name="l00103"></a>00103      <span class="keywordflow">return</span> IPPROTO_TCP;
<a name="l00104"></a>00104    <span class="keywordflow">else</span>
<a name="l00105"></a>00105      <span class="keywordflow">return</span> IPPROTO_IP ; <span class="comment">/* Dummy output */</span>
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="keyword">static</span> <a class="code" href="structhash__table.html">hash_table_t</a> * get_ht_by_xprt( SVCXPRT * xprt )
<a name="l00110"></a>00110 {
<a name="l00111"></a>00111    <span class="keywordflow">return</span> (get_ipproto_by_xprt( xprt )==IPPROTO_UDP)?ht_dupreq_udp:<a class="code" href="nfs__dupreq_8c.html#a6886caab6efa0f98e18c1fc2b2bec54b">ht_dupreq_tcp</a> ;
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 
<a name="l00127"></a><a class="code" href="nfs__dupreq_8c.html#af812dda060fd0aa4f965adadb15dd22d">00127</a> <span class="keywordtype">int</span> <a class="code" href="nfs__core_8h.html#af812dda060fd0aa4f965adadb15dd22d">print_entry_dupreq</a>(<a class="code" href="structLRU__data____.html">LRU_data_t</a> data, <span class="keywordtype">char</span> *str)
<a name="l00128"></a>00128 {
<a name="l00129"></a>00129   strcpy(str, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00130"></a>00130   <span class="keywordflow">return</span> 0;
<a name="l00131"></a>00131 }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="keyword">static</span> <span class="keywordtype">int</span> _remove_dupreq(<a class="code" href="structhash__table.html">hash_table_t</a> *ht_dupreq, <a class="code" href="structhash__buff.html">hash_buffer_t</a> *buffkey,
<a name="l00134"></a>00134                           <a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *pdupreq, <span class="keywordtype">int</span> nfs_req_status)
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136   <span class="keywordtype">int</span> rc;
<a name="l00137"></a>00137   <a class="code" href="structnfs__function__desc____.html">nfs_function_desc_t</a> funcdesc = nfs2_func_desc[0];
<a name="l00138"></a>00138   <a class="code" href="structhash__buff.html">hash_buffer_t</a> usedbuffkey;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140   rc = HashTable_Del(ht_dupreq, buffkey, &amp;usedbuffkey, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142   <span class="comment">/* if hashtable no such key =&gt; dupreq garbaged by another thread */</span>
<a name="l00143"></a>00143   <span class="keywordflow">if</span>(rc != <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a> &amp;&amp; rc != <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1af64969299d286caf4ae0ec62f44d6c79">HASHTABLE_ERROR_NO_SUCH_KEY</a>)
<a name="l00144"></a>00144     <span class="keywordflow">return</span> 1;                   <span class="comment">/* Error while cleaning */</span>
<a name="l00145"></a>00145   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rc == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1af64969299d286caf4ae0ec62f44d6c79">HASHTABLE_ERROR_NO_SUCH_KEY</a>)
<a name="l00146"></a>00146     <span class="keywordflow">return</span> 0;                   <span class="comment">/* don&#39;t free the dupreq twice */</span>
<a name="l00147"></a>00147 
<a name="l00148"></a>00148   <span class="comment">/* Locate the function descriptor associated with this cached request */</span>
<a name="l00149"></a>00149   <span class="keywordflow">if</span>(pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a> == <a class="code" href="nfs__core_8h.html#aeb8fc46586993cf210777049fca03969">nfs_param</a>.<a class="code" href="structnfs__param____.html#aeef2995e9b54747311db1972d158fd41">core_param</a>.<a class="code" href="structnfs__core__param____.html#aa04e466147819b7a92794e45e67ad2c9">program</a>[<a class="code" href="nfs__core_8h.html#a7f6e26c17a511d03a3e095f595a02907a69c56a6ce312422c90b25f97a43d4dc2">P_NFS</a>])
<a name="l00150"></a>00150     {
<a name="l00151"></a>00151       <span class="keywordflow">switch</span> (pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#aa1935cf700638c05df989061b6c3e0a1">rq_vers</a>)
<a name="l00152"></a>00152         {
<a name="l00153"></a>00153         <span class="keywordflow">case</span> <a class="code" href="nfs23_8h.html#ab7bf618affb552e91b562c195b52b6a7">NFS_V2</a>:
<a name="l00154"></a>00154           funcdesc = nfs2_func_desc[pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a05c1244b60ad6a41dc151319a3294e5d">rq_proc</a>];
<a name="l00155"></a>00155           <span class="keywordflow">break</span>;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157         <span class="keywordflow">case</span> <a class="code" href="nfs23_8h.html#ad0f0a57c0aacb6093af91d085b807cbd">NFS_V3</a>:
<a name="l00158"></a>00158           funcdesc = nfs3_func_desc[pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a05c1244b60ad6a41dc151319a3294e5d">rq_proc</a>];
<a name="l00159"></a>00159           <span class="keywordflow">break</span>;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161         <span class="keywordflow">case</span> <a class="code" href="nfsv40_8h.html#a38cfe5720671dbafe5d1b278f6fe9dec">NFS_V4</a>:
<a name="l00162"></a>00162           funcdesc = nfs4_func_desc[pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a05c1244b60ad6a41dc151319a3294e5d">rq_proc</a>];
<a name="l00163"></a>00163           <span class="keywordflow">break</span>;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         <span class="keywordflow">default</span>:
<a name="l00166"></a>00166           <span class="comment">/* We should never go there (this situation is filtered in nfs_rpc_getreq) */</span>
<a name="l00167"></a>00167           <a class="code" href="log_8h.html#a3cf3c22fac6bb9871e25007551caeb13">LogMajor</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556ab22e11ab2329da5c014538bee4066181">COMPONENT_DUPREQ</a>,
<a name="l00168"></a>00168                    <span class="stringliteral">&quot;NFS Protocol version %d unknown in dupreq_gc&quot;</span>,
<a name="l00169"></a>00169                    (<span class="keywordtype">int</span>)pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#aa1935cf700638c05df989061b6c3e0a1">rq_vers</a>);
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a> == <a class="code" href="nfs__core_8h.html#aeb8fc46586993cf210777049fca03969">nfs_param</a>.<a class="code" href="structnfs__param____.html#aeef2995e9b54747311db1972d158fd41">core_param</a>.<a class="code" href="structnfs__core__param____.html#aa04e466147819b7a92794e45e67ad2c9">program</a>[<a class="code" href="nfs__core_8h.html#a7f6e26c17a511d03a3e095f595a02907a9c790ab4adce0dd1d4dde907f1211eb4">P_MNT</a>])
<a name="l00173"></a>00173     {
<a name="l00174"></a>00174       <span class="keywordflow">switch</span> (pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#aa1935cf700638c05df989061b6c3e0a1">rq_vers</a>)
<a name="l00175"></a>00175         {
<a name="l00176"></a>00176         <span class="keywordflow">case</span> <a class="code" href="mount_8h.html#a1b68bc78418850d3ec380cd17106c913">MOUNT_V1</a>:
<a name="l00177"></a>00177           funcdesc = mnt1_func_desc[pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a05c1244b60ad6a41dc151319a3294e5d">rq_proc</a>];
<a name="l00178"></a>00178           <span class="keywordflow">break</span>;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180         <span class="keywordflow">case</span> <a class="code" href="mount_8h.html#a12f1699613f9b6e2ca86537be080c567">MOUNT_V3</a>:
<a name="l00181"></a>00181           funcdesc = mnt3_func_desc[pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a05c1244b60ad6a41dc151319a3294e5d">rq_proc</a>];
<a name="l00182"></a>00182           <span class="keywordflow">break</span>;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184         <span class="keywordflow">default</span>:
<a name="l00185"></a>00185           <span class="comment">/* We should never go there (this situation is filtered in nfs_rpc_getreq) */</span>
<a name="l00186"></a>00186           <a class="code" href="log_8h.html#a3cf3c22fac6bb9871e25007551caeb13">LogMajor</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556ab22e11ab2329da5c014538bee4066181">COMPONENT_DUPREQ</a>,
<a name="l00187"></a>00187                    <span class="stringliteral">&quot;MOUNT Protocol version %d unknown in dupreq_gc&quot;</span>,
<a name="l00188"></a>00188                    (<span class="keywordtype">int</span>)pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#aa1935cf700638c05df989061b6c3e0a1">rq_vers</a>);
<a name="l00189"></a>00189           <span class="keywordflow">break</span>;
<a name="l00190"></a>00190         }                       <span class="comment">/* switch( pdupreq-&gt;vers ) */</span>
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192 <span class="preprocessor">#ifdef _USE_NLM</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a> == <a class="code" href="nfs__core_8h.html#aeb8fc46586993cf210777049fca03969">nfs_param</a>.<a class="code" href="structnfs__param____.html#aeef2995e9b54747311db1972d158fd41">core_param</a>.<a class="code" href="structnfs__core__param____.html#aa04e466147819b7a92794e45e67ad2c9">program</a>[P_NLM])
<a name="l00194"></a>00194     {
<a name="l00195"></a>00195 
<a name="l00196"></a>00196       <span class="keywordflow">switch</span> (pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#aa1935cf700638c05df989061b6c3e0a1">rq_vers</a>)
<a name="l00197"></a>00197         {
<a name="l00198"></a>00198         <span class="keywordflow">case</span> <a class="code" href="nlm4_8h.html#a77d7904b6e8b9680a169ff75b341bb84">NLM4_VERS</a>:
<a name="l00199"></a>00199           funcdesc = nlm4_func_desc[pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a05c1244b60ad6a41dc151319a3294e5d">rq_proc</a>];
<a name="l00200"></a>00200           <span class="keywordflow">break</span>;
<a name="l00201"></a>00201         }                       <span class="comment">/* switch( pdupreq-&gt;vers ) */</span>
<a name="l00202"></a>00202     }
<a name="l00203"></a>00203 <span class="preprocessor">#endif                          </span><span class="comment">/* _USE_NLM */</span>
<a name="l00204"></a>00204 <span class="preprocessor">#ifdef _USE_RQUOTA</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a> == <a class="code" href="nfs__core_8h.html#aeb8fc46586993cf210777049fca03969">nfs_param</a>.<a class="code" href="structnfs__param____.html#aeef2995e9b54747311db1972d158fd41">core_param</a>.<a class="code" href="structnfs__core__param____.html#aa04e466147819b7a92794e45e67ad2c9">program</a>[P_RQUOTA])
<a name="l00206"></a>00206     {
<a name="l00207"></a>00207 
<a name="l00208"></a>00208       <span class="keywordflow">switch</span> (pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#aa1935cf700638c05df989061b6c3e0a1">rq_vers</a>)
<a name="l00209"></a>00209         {
<a name="l00210"></a>00210         <span class="keywordflow">case</span> <a class="code" href="rquota_8h.html#ac79dc26de161d86cf32482a5573cc767">RQUOTAVERS</a>:
<a name="l00211"></a>00211           funcdesc = rquota1_func_desc[pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a05c1244b60ad6a41dc151319a3294e5d">rq_proc</a>];
<a name="l00212"></a>00212           <span class="keywordflow">break</span>;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214         <span class="keywordflow">case</span> <a class="code" href="rquota_8h.html#a669e05a2522ab72aa2b0e8aa8323d883">EXT_RQUOTAVERS</a>:
<a name="l00215"></a>00215           funcdesc = rquota2_func_desc[pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a05c1244b60ad6a41dc151319a3294e5d">rq_proc</a>];
<a name="l00216"></a>00216           <span class="keywordflow">break</span>;
<a name="l00217"></a>00217         }                       <span class="comment">/* switch( pdupreq-&gt;vers ) */</span>
<a name="l00218"></a>00218     }
<a name="l00219"></a>00219 <span class="preprocessor">#endif</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span>  <span class="keywordflow">else</span>
<a name="l00221"></a>00221     {
<a name="l00222"></a>00222       <span class="comment">/* We should never go there (this situation is filtered in nfs_rpc_getreq) */</span>
<a name="l00223"></a>00223       <a class="code" href="log_8h.html#a3cf3c22fac6bb9871e25007551caeb13">LogMajor</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556ab22e11ab2329da5c014538bee4066181">COMPONENT_DUPREQ</a>,
<a name="l00224"></a>00224                <span class="stringliteral">&quot;protocol %d is not managed&quot;</span>,
<a name="l00225"></a>00225                (<span class="keywordtype">int</span>)pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a>);
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <span class="comment">/* Call the free function */</span>
<a name="l00229"></a>00229   <span class="keywordflow">if</span> (nfs_req_status == <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>)
<a name="l00230"></a>00230     funcdesc.<a class="code" href="group__NFSprocs.html#gaba4e84d16617a16550fa57dcc42ecee0">free_function</a>(&amp;(pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a91759815834de60b78ee4c3d53da76cd">res_nfs</a>));
<a name="l00231"></a>00231 
<a name="l00232"></a>00232   <span class="comment">/* Send the entry back to the pool */</span>
<a name="l00233"></a>00233   pool_free(<a class="code" href="nfs__core_8h.html#a120af9c25da978b5bec06f8ca0453219">dupreq_pool</a>, pdupreq);
<a name="l00234"></a>00234   gsh_free(usedbuffkey.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236   <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa081a1934d0972db9961d46f25d264ff9">DUPREQ_SUCCESS</a>;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="nfs__dupreq_8c.html#ad30cdf2e72a3a44f95f951cc1572198d">00239</a> <span class="keywordtype">int</span> <a class="code" href="nfs__dupreq_8h.html#ad30cdf2e72a3a44f95f951cc1572198d">nfs_dupreq_delete</a>(<span class="keyword">struct</span> svc_req *req)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241   <span class="keywordtype">int</span> status;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffkey;
<a name="l00244"></a>00244   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffval;
<a name="l00245"></a>00245   <a class="code" href="structdupreq__key____.html">dupreq_key_t</a> dupkey;
<a name="l00246"></a>00246   <a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *pdupreq;
<a name="l00247"></a>00247   <a class="code" href="structhash__table.html">hash_table_t</a> * ht_dupreq = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249   <span class="comment">/* Get correct HT depending on proto used */</span>
<a name="l00250"></a>00250   ht_dupreq = get_ht_by_xprt(req-&gt;rq_xprt) ;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252   <span class="comment">/* Get the socket address for the key */</span>
<a name="l00253"></a>00253   <span class="keywordflow">if</span>(<a class="code" href="ganesha__rpc_8h.html#ac79de7952a084c98f9dfeba5e1ac0556">copy_xprt_addr</a>(&amp;dupkey.<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>, req-&gt;rq_xprt) == 0)
<a name="l00254"></a>00254     <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa5e1858a0b91c975314d7316be31c0bcd">DUPREQ_NOT_FOUND</a>;
<a name="l00255"></a>00255 
<a name="l00256"></a>00256   dupkey.<a class="code" href="structdupreq__key____.html#aca61acb884341d8130a0b5d27101f42c">xid</a> = req-&gt;rq_xid;
<a name="l00257"></a>00257   dupkey.<a class="code" href="structdupreq__key____.html#a19bcf815511eb6ed35ba6943d512cba7">checksum</a> = 0;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259   <span class="comment">/* I have to keep an integer as key, I wil use the pointer buffkey-&gt;pdata for this,</span>
<a name="l00260"></a>00260 <span class="comment">   * this also means that buffkey-&gt;len will be 0 */</span>
<a name="l00261"></a>00261   buffkey.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) &amp;dupkey;
<a name="l00262"></a>00262   buffkey.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(<a class="code" href="nfs__dupreq_8h.html#a928052411953c17dd2c4c48ecebce48b">dupreq_key_t</a>);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264   <span class="keywordflow">if</span>(HashTable_Get(ht_dupreq, &amp;buffkey, &amp;buffval) == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>)
<a name="l00265"></a>00265     {
<a name="l00266"></a>00266       pdupreq = (<a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *) buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00267"></a>00267 
<a name="l00268"></a>00268       <span class="comment">/* reset timestamp */</span>
<a name="l00269"></a>00269       pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a8e4cbe7b4e0224924a8c99cfbdb93d9b">timestamp</a> = time(<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00270"></a>00270 
<a name="l00271"></a>00271       status = <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa081a1934d0972db9961d46f25d264ff9">DUPREQ_SUCCESS</a>;
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273   <span class="keywordflow">else</span> {
<a name="l00274"></a>00274     <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa5e1858a0b91c975314d7316be31c0bcd">DUPREQ_NOT_FOUND</a>;
<a name="l00275"></a>00275   }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277   <a class="code" href="nfs__dupreq_8c.html#a19a92c1cca2c6d33998dddd4094eef7f">LogDupReq</a>(<span class="stringliteral">&quot;REMOVING&quot;</span>, &amp;pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a5b17b67b0d53ad23d5298bff2e689178">addr</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a02e9d24e871412dc20f93c843dd31e1b">xid</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a>);
<a name="l00278"></a>00278 
<a name="l00279"></a>00279   status = _remove_dupreq( ht_dupreq, &amp;buffkey, pdupreq, !<a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>);
<a name="l00280"></a>00280   <span class="keywordflow">return</span> status;
<a name="l00281"></a>00281 }
<a name="l00282"></a>00282 
<a name="l00295"></a><a class="code" href="nfs__dupreq_8c.html#a0dd9a264f91e9823e807b34e6994f777">00295</a> <span class="keywordtype">int</span> <a class="code" href="nfs__core_8h.html#a0dd9a264f91e9823e807b34e6994f777">clean_entry_dupreq</a>(<a class="code" href="structlru__entry____.html">LRU_entry_t</a> *pentry, <span class="keywordtype">void</span> *addparam)
<a name="l00296"></a>00296 {
<a name="l00297"></a>00297   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffkey;
<a name="l00298"></a>00298   <a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *pdupreq = (<a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *) (pentry-&gt;<a class="code" href="structlru__entry____.html#a8c131e4292bf1f64731ee20726902ab4">buffdata</a>.<a class="code" href="structLRU__data____.html#a59f72c5e75d16cabb60c4fdac12421f4">pdata</a>);
<a name="l00299"></a>00299   <a class="code" href="structdupreq__key____.html">dupreq_key_t</a> dupkey;
<a name="l00300"></a>00300   <a class="code" href="structhash__table.html">hash_table_t</a> * ht_dupreq = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302   <span class="comment">/* Get the socket address for the key */</span>
<a name="l00303"></a>00303   memcpy((<span class="keywordtype">char</span> *)&amp;dupkey.<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>, (<span class="keywordtype">char</span> *)&amp;pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a5b17b67b0d53ad23d5298bff2e689178">addr</a>, <span class="keyword">sizeof</span>(dupkey.<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>));
<a name="l00304"></a>00304   dupkey.<a class="code" href="structdupreq__key____.html#aca61acb884341d8130a0b5d27101f42c">xid</a> = pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a02e9d24e871412dc20f93c843dd31e1b">xid</a>;
<a name="l00305"></a>00305   dupkey.<a class="code" href="structdupreq__key____.html#a19bcf815511eb6ed35ba6943d512cba7">checksum</a> = pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#ad828158567f49558b075d22e5d75dddf">checksum</a>;
<a name="l00306"></a>00306 
<a name="l00307"></a>00307   <span class="comment">/* I have to keep an integer as key, I wil use the pointer buffkey-&gt;pdata for this,</span>
<a name="l00308"></a>00308 <span class="comment">   * this also means that buffkey-&gt;len will be 0 */</span>
<a name="l00309"></a>00309   buffkey.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) &amp;dupkey;
<a name="l00310"></a>00310   buffkey.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(<a class="code" href="nfs__dupreq_8h.html#a928052411953c17dd2c4c48ecebce48b">dupreq_key_t</a>);
<a name="l00311"></a>00311 
<a name="l00312"></a>00312   <span class="comment">/* Get correct HT depending on proto used */</span>
<a name="l00313"></a>00313   <span class="keywordflow">if</span>( pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a0f0bc3f2eabd5e2ae79dd7c1f6d7e438">ipproto</a> == IPPROTO_TCP )
<a name="l00314"></a>00314      ht_dupreq = <a class="code" href="nfs__dupreq_8c.html#a6886caab6efa0f98e18c1fc2b2bec54b">ht_dupreq_tcp</a> ;
<a name="l00315"></a>00315   <span class="keywordflow">else</span>
<a name="l00316"></a>00316      ht_dupreq = <a class="code" href="nfs__dupreq_8c.html#ab41dfb8f9862268dfce85547de3d5ee9">ht_dupreq_udp</a> ;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318   <a class="code" href="nfs__dupreq_8c.html#a19a92c1cca2c6d33998dddd4094eef7f">LogDupReq</a>(<span class="stringliteral">&quot;Garbage collection on&quot;</span>, &amp;pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a5b17b67b0d53ad23d5298bff2e689178">addr</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a02e9d24e871412dc20f93c843dd31e1b">xid</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a>);
<a name="l00319"></a>00319 
<a name="l00320"></a>00320   <span class="keywordflow">return</span> _remove_dupreq(ht_dupreq, &amp;buffkey, pdupreq, <a class="code" href="group__NFSprocs.html#ga2c5937c697db19bb296a6393191d5600">NFS_REQ_OK</a>);
<a name="l00321"></a>00321 }                               <span class="comment">/* clean_entry_dupreq */</span>
<a name="l00322"></a>00322 
<a name="l00340"></a><a class="code" href="nfs__dupreq_8c.html#a720f58beecb1f29712e83373b56568d4">00340</a> <a class="code" href="extended__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="nfs__dupreq_8h.html#a720f58beecb1f29712e83373b56568d4">dupreq_value_hash_func</a>(<a class="code" href="structhash__param.html">hash_parameter_t</a> * p_hparam,
<a name="l00341"></a>00341                                 <a class="code" href="structhash__buff.html">hash_buffer_t</a> * buffclef)
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343   <a class="code" href="structdupreq__key____.html">dupreq_key_t</a> *pdupkey = (<a class="code" href="structdupreq__key____.html">dupreq_key_t</a> *)(buffclef-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>);
<a name="l00344"></a>00344   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr_hash = <a class="code" href="ganesha__rpc_8h.html#ac0f59802ffde0852db982956f4fa1dd3">hash_sockaddr</a>((<a class="code" href="ganesha__rpc_8h.html#a42f3261a45141da24a6d18194eae1c91">sockaddr_t</a> *) &amp;pdupkey-&gt;<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>, <a class="code" href="ganesha__rpc_8h.html#afcd5135f52e24ba302e32f244d0a5faca8be018be4c7b5e16ec63bf8cde4cc344">CHECK_PORT</a>);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346   <span class="keywordflow">return</span> (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)pdupkey-&gt;<a class="code" href="structdupreq__key____.html#aca61acb884341d8130a0b5d27101f42c">xid</a> + addr_hash)^(pdupkey-&gt;<a class="code" href="structdupreq__key____.html#a19bcf815511eb6ed35ba6943d512cba7">checksum</a>)) % p_hparam-&gt;<a class="code" href="structhash__param.html#ac835083bd319700097c852ab29852d69">index_size</a>;
<a name="l00347"></a>00347 }                               <span class="comment">/*  dupreq_value_hash_func */</span>
<a name="l00348"></a>00348 
<a name="l00365"></a><a class="code" href="nfs__dupreq_8c.html#a62874e829e04af8882e6314fcecf3945">00365</a> <a class="code" href="extended__types_8h.html#ad27ed092432b64ff558d2254c278720f">uint64_t</a> <a class="code" href="nfs__dupreq_8h.html#a62874e829e04af8882e6314fcecf3945">dupreq_rbt_hash_func</a>(<a class="code" href="structhash__param.html">hash_parameter_t</a> * p_hparam, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * buffclef)
<a name="l00366"></a>00366 {
<a name="l00367"></a>00367   <a class="code" href="structdupreq__key____.html">dupreq_key_t</a> *pdupkey = (<a class="code" href="structdupreq__key____.html">dupreq_key_t</a> *)(buffclef-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> addr_hash = <a class="code" href="ganesha__rpc_8h.html#ac0f59802ffde0852db982956f4fa1dd3">hash_sockaddr</a>((<a class="code" href="ganesha__rpc_8h.html#a42f3261a45141da24a6d18194eae1c91">sockaddr_t</a> *) &amp;pdupkey-&gt;<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>, <a class="code" href="ganesha__rpc_8h.html#afcd5135f52e24ba302e32f244d0a5faca8be018be4c7b5e16ec63bf8cde4cc344">CHECK_PORT</a>);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371   <span class="keywordflow">return</span> (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)pdupkey-&gt;<a class="code" href="structdupreq__key____.html#aca61acb884341d8130a0b5d27101f42c">xid</a> + addr_hash)^(pdupkey-&gt;<a class="code" href="structdupreq__key____.html#a19bcf815511eb6ed35ba6943d512cba7">checksum</a>));
<a name="l00372"></a>00372 }                               <span class="comment">/* dupreq_rbt_hash_func */</span>
<a name="l00373"></a>00373 
<a name="l00390"></a><a class="code" href="nfs__dupreq_8c.html#ae097a7ca8bfad0e9658feb038835a83c">00390</a> <span class="keywordtype">int</span> <a class="code" href="nfs__core_8h.html#ae097a7ca8bfad0e9658feb038835a83c">compare_req</a>(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * buff1, <a class="code" href="structhash__buff.html">hash_buffer_t</a> * buff2)
<a name="l00391"></a>00391 {
<a name="l00392"></a>00392   <a class="code" href="structdupreq__key____.html">dupreq_key_t</a> *key1 = (<a class="code" href="structdupreq__key____.html">dupreq_key_t</a> *)(buff1-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>);
<a name="l00393"></a>00393   <a class="code" href="structdupreq__key____.html">dupreq_key_t</a> *key2 = (<a class="code" href="structdupreq__key____.html">dupreq_key_t</a> *)(buff2-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>);
<a name="l00394"></a>00394 
<a name="l00395"></a>00395   <span class="keywordflow">if</span> (key1-&gt;<a class="code" href="structdupreq__key____.html#aca61acb884341d8130a0b5d27101f42c">xid</a> != key2-&gt;<a class="code" href="structdupreq__key____.html#aca61acb884341d8130a0b5d27101f42c">xid</a>)
<a name="l00396"></a>00396     <span class="keywordflow">return</span> 1;
<a name="l00397"></a>00397   <span class="keywordflow">if</span> (<a class="code" href="ganesha__rpc_8h.html#a59259274830ed5c91b2f41b6a94bf9c2">cmp_sockaddr</a>(&amp;key1-&gt;<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>, &amp;key2-&gt;<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>, <a class="code" href="ganesha__rpc_8h.html#afcd5135f52e24ba302e32f244d0a5faca8be018be4c7b5e16ec63bf8cde4cc344">CHECK_PORT</a>) == 0)
<a name="l00398"></a>00398     <span class="keywordflow">return</span> 1;
<a name="l00399"></a>00399   <span class="keywordflow">if</span> (key1-&gt;<a class="code" href="structdupreq__key____.html#a19bcf815511eb6ed35ba6943d512cba7">checksum</a> != key2-&gt;<a class="code" href="structdupreq__key____.html#a19bcf815511eb6ed35ba6943d512cba7">checksum</a>)
<a name="l00400"></a>00400     <span class="keywordflow">return</span> 1;
<a name="l00401"></a>00401   <span class="keywordflow">return</span> 0;
<a name="l00402"></a>00402 }                               <span class="comment">/* compare_xid */</span>
<a name="l00403"></a>00403 
<a name="l00417"></a><a class="code" href="nfs__dupreq_8c.html#ace76340b85dd6bb0f65608bcced8a634">00417</a> <span class="keywordtype">int</span> <a class="code" href="nfs__core_8h.html#ace76340b85dd6bb0f65608bcced8a634">display_req_key</a>(<a class="code" href="structhash__buff.html">hash_buffer_t</a> * pbuff, <span class="keywordtype">char</span> *str)
<a name="l00418"></a>00418 {
<a name="l00419"></a>00419   <a class="code" href="structdupreq__key____.html">dupreq_key_t</a> *pdupkey = (<a class="code" href="structdupreq__key____.html">dupreq_key_t</a> *)(pbuff-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>);
<a name="l00420"></a>00420   <span class="keywordtype">char</span> namebuf[<a class="code" href="ganesha__rpc_8h.html#a9174d973fdbe2abdc1987d702b5b7d1a">SOCK_NAME_MAX</a>];
<a name="l00421"></a>00421 
<a name="l00422"></a>00422   <a class="code" href="ganesha__rpc_8h.html#a798e3040dc5734e965e36b405958f984">sprint_sockaddr</a>(&amp;pdupkey-&gt;<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>, namebuf, <span class="keyword">sizeof</span>(namebuf));
<a name="l00423"></a>00423 
<a name="l00424"></a>00424   <span class="keywordflow">return</span> sprintf(str, <span class="stringliteral">&quot;addr=%s xid=%ld checksum=%d&quot;</span>,
<a name="l00425"></a>00425                  namebuf, pdupkey-&gt;<a class="code" href="structdupreq__key____.html#aca61acb884341d8130a0b5d27101f42c">xid</a>, pdupkey-&gt;<a class="code" href="structdupreq__key____.html#a19bcf815511eb6ed35ba6943d512cba7">checksum</a>);
<a name="l00426"></a>00426 
<a name="l00427"></a>00427 }
<a name="l00428"></a>00428 
<a name="l00442"></a><a class="code" href="nfs__dupreq_8c.html#a83a5c6ccfa97ddd8c53de02bd77a7277">00442</a> <span class="keywordtype">int</span> <a class="code" href="nfs__core_8h.html#a83a5c6ccfa97ddd8c53de02bd77a7277">display_req_val</a>(<a class="code" href="structhash__buff.html">hash_buffer_t</a> *pbuff, <span class="keywordtype">char</span> *str)
<a name="l00443"></a>00443 {
<a name="l00444"></a>00444   <a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *pdupreq = (<a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *)(pbuff-&gt;<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>);
<a name="l00445"></a>00445   <span class="keywordtype">char</span> namebuf[<a class="code" href="ganesha__rpc_8h.html#a9174d973fdbe2abdc1987d702b5b7d1a">SOCK_NAME_MAX</a>];
<a name="l00446"></a>00446 
<a name="l00447"></a>00447   <a class="code" href="ganesha__rpc_8h.html#a798e3040dc5734e965e36b405958f984">sprint_sockaddr</a>(&amp;pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a5b17b67b0d53ad23d5298bff2e689178">addr</a>, namebuf, <span class="keyword">sizeof</span>(namebuf));
<a name="l00448"></a>00448 
<a name="l00449"></a>00449   <span class="keywordflow">return</span> sprintf(str, <span class="stringliteral">&quot;addr=%s xid=%ld checksum=%d rq_prog=%lu rq_vers=%lu rq_proc=%lu&quot;</span>,
<a name="l00450"></a>00450                  namebuf, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a02e9d24e871412dc20f93c843dd31e1b">xid</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#ad828158567f49558b075d22e5d75dddf">checksum</a>,
<a name="l00451"></a>00451                  pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#aa1935cf700638c05df989061b6c3e0a1">rq_vers</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a05c1244b60ad6a41dc151319a3294e5d">rq_proc</a>);
<a name="l00452"></a>00452 }
<a name="l00453"></a>00453 
<a name="l00465"></a><a class="code" href="nfs__dupreq_8c.html#a0e0c7a1fda2f7d756dd1b2f8b4f97db6">00465</a> <span class="keywordtype">int</span> <a class="code" href="nfs__core_8h.html#a0e0c7a1fda2f7d756dd1b2f8b4f97db6">nfs_Init_dupreq</a>(<a class="code" href="structnfs__rpc__dupreq__param____.html">nfs_rpc_dupreq_parameter_t</a> <a class="code" href="Connectathon__config__parsing_8c.html#a84f6f668b79957f185ab5a6c535f2e7c">param</a>)
<a name="l00466"></a>00466 {
<a name="l00467"></a>00467   <span class="keywordflow">if</span>((ht_dupreq_udp = <a class="code" href="group__HTExported.html#ga49502e8329739f9789ec4423289235d2" title="Initialize a new hash table.">HashTable_Init</a>(&amp;param.<a class="code" href="structnfs__rpc__dupreq__param____.html#a5b4378e8179e69873bd49e13e9926d08">hash_param</a>)) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00468"></a>00468     {
<a name="l00469"></a>00469       <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556ab22e11ab2329da5c014538bee4066181">COMPONENT_DUPREQ</a>,
<a name="l00470"></a>00470               <span class="stringliteral">&quot;Cannot init the duplicate request hash table&quot;</span>);
<a name="l00471"></a>00471       <span class="keywordflow">return</span> -1;
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   <span class="keywordflow">if</span>((ht_dupreq_tcp = <a class="code" href="group__HTExported.html#ga49502e8329739f9789ec4423289235d2" title="Initialize a new hash table.">HashTable_Init</a>(&amp;param.<a class="code" href="structnfs__rpc__dupreq__param____.html#a5b4378e8179e69873bd49e13e9926d08">hash_param</a>)) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00475"></a>00475     {
<a name="l00476"></a>00476       <a class="code" href="test__findlog_8c.html#adfd9432c5478fa14c7d678edb301feed">LogCrit</a>(<a class="code" href="log_8h.html#aef38a41286a6a40320bc7d64135b1556ab22e11ab2329da5c014538bee4066181">COMPONENT_DUPREQ</a>,
<a name="l00477"></a>00477               <span class="stringliteral">&quot;Cannot init the duplicate request hash table&quot;</span>);
<a name="l00478"></a>00478       <span class="keywordflow">return</span> -1;
<a name="l00479"></a>00479     }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 
<a name="l00482"></a>00482   <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa081a1934d0972db9961d46f25d264ff9">DUPREQ_SUCCESS</a>;
<a name="l00483"></a>00483 }                               <span class="comment">/* nfs_Init_dupreq */</span>
<a name="l00484"></a>00484 
<a name="l00499"></a><a class="code" href="nfs__dupreq_8c.html#accd676b25fd8adda77faf10c37f5a71b">00499</a> <span class="keywordtype">int</span> <a class="code" href="nfs__dupreq_8h.html#accd676b25fd8adda77faf10c37f5a71b">nfs_dupreq_add_not_finished</a>(<span class="keyword">struct</span> svc_req *req,
<a name="l00500"></a>00500                                 <a class="code" href="unionnfs__res____.html">nfs_res_t</a> *res_nfs)
<a name="l00501"></a>00501 {
<a name="l00502"></a>00502   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffkey;
<a name="l00503"></a>00503   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffval;
<a name="l00504"></a>00504   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffdata;
<a name="l00505"></a>00505   <a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *pdupreq = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00506"></a>00506   <span class="keywordtype">int</span> status = 0;
<a name="l00507"></a>00507   <a class="code" href="structdupreq__key____.html">dupreq_key_t</a> *pdupkey = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00508"></a>00508   <a class="code" href="structhash__table.html">hash_table_t</a> * ht_dupreq = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510   <span class="comment">/* Get correct HT depending on proto used */</span>
<a name="l00511"></a>00511   ht_dupreq = get_ht_by_xprt(req-&gt;rq_xprt);
<a name="l00512"></a>00512   <span class="comment">/* Entry to be cached */</span>
<a name="l00513"></a>00513   pdupreq = pool_alloc(<a class="code" href="nfs__core_8h.html#a120af9c25da978b5bec06f8ca0453219">dupreq_pool</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00514"></a>00514   <span class="keywordflow">if</span>(pdupreq == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00515"></a>00515     <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faabf8d181a38bfc1ee1a745a9c8b7f5e6d">DUPREQ_INSERT_MALLOC_ERROR</a>;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517   <span class="keywordflow">if</span>(pthread_mutex_init(&amp;pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#aa748a8db7613dddc13e5cddc70bb310f">dupreq_mutex</a>, <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) == -1)
<a name="l00518"></a>00518     {
<a name="l00519"></a>00519       pool_free(<a class="code" href="nfs__core_8h.html#a120af9c25da978b5bec06f8ca0453219">dupreq_pool</a>, pdupreq);
<a name="l00520"></a>00520       <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faabf8d181a38bfc1ee1a745a9c8b7f5e6d">DUPREQ_INSERT_MALLOC_ERROR</a>;
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523   <span class="keywordflow">if</span>((pdupkey = gsh_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structdupreq__key____.html">dupreq_key_t</a>))) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00524"></a>00524     {
<a name="l00525"></a>00525       pool_free(<a class="code" href="nfs__core_8h.html#a120af9c25da978b5bec06f8ca0453219">dupreq_pool</a>, pdupreq);
<a name="l00526"></a>00526       <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faabf8d181a38bfc1ee1a745a9c8b7f5e6d">DUPREQ_INSERT_MALLOC_ERROR</a>;
<a name="l00527"></a>00527     }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529   <span class="comment">/* Get the socket address for the key and the request */</span>
<a name="l00530"></a>00530   <span class="keywordflow">if</span>(<a class="code" href="ganesha__rpc_8h.html#ac79de7952a084c98f9dfeba5e1ac0556">copy_xprt_addr</a>(&amp;pdupkey-&gt;<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>, req-&gt;rq_xprt) == 0 ||
<a name="l00531"></a>00531      <a class="code" href="ganesha__rpc_8h.html#ac79de7952a084c98f9dfeba5e1ac0556">copy_xprt_addr</a>(&amp;pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a5b17b67b0d53ad23d5298bff2e689178">addr</a>, req-&gt;rq_xprt) == 0)
<a name="l00532"></a>00532     {
<a name="l00533"></a>00533       gsh_free(pdupkey);
<a name="l00534"></a>00534       pool_free(<a class="code" href="nfs__core_8h.html#a120af9c25da978b5bec06f8ca0453219">dupreq_pool</a>, pdupreq);
<a name="l00535"></a>00535       <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faabf8d181a38bfc1ee1a745a9c8b7f5e6d">DUPREQ_INSERT_MALLOC_ERROR</a>;
<a name="l00536"></a>00536     }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538   pdupkey-&gt;<a class="code" href="structdupreq__key____.html#aca61acb884341d8130a0b5d27101f42c">xid</a> = req-&gt;rq_xid;
<a name="l00539"></a>00539   pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a02e9d24e871412dc20f93c843dd31e1b">xid</a> = req-&gt;rq_xid;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541   <span class="comment">/* Checksum the request */</span>
<a name="l00542"></a>00542   pdupkey-&gt;<a class="code" href="structdupreq__key____.html#a19bcf815511eb6ed35ba6943d512cba7">checksum</a> = 0;
<a name="l00543"></a>00543   pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#ad828158567f49558b075d22e5d75dddf">checksum</a> = 0;
<a name="l00544"></a>00544 
<a name="l00545"></a>00545   <span class="comment">/* I have to keep an integer as key, I wil use the pointer buffkey-&gt;pdata for this,</span>
<a name="l00546"></a>00546 <span class="comment">   * this also means that buffkey-&gt;len will be 0 */</span>
<a name="l00547"></a>00547   buffkey.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) pdupkey;
<a name="l00548"></a>00548   buffkey.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(<a class="code" href="nfs__dupreq_8h.html#a928052411953c17dd2c4c48ecebce48b">dupreq_key_t</a>);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550   <span class="comment">/* I build the data with the request pointer that should be in state &#39;IN USE&#39; */</span>
<a name="l00551"></a>00551   pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a> = req-&gt;rq_prog;
<a name="l00552"></a>00552   pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#aa1935cf700638c05df989061b6c3e0a1">rq_vers</a> = req-&gt;rq_vers;
<a name="l00553"></a>00553   pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a05c1244b60ad6a41dc151319a3294e5d">rq_proc</a> = req-&gt;rq_proc;
<a name="l00554"></a>00554   pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a8e4cbe7b4e0224924a8c99cfbdb93d9b">timestamp</a> = time(<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00555"></a>00555   pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#ab25c3db1f9ae861daf4d183a706cd1bf">processing</a> = 1;
<a name="l00556"></a>00556   pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a0f0bc3f2eabd5e2ae79dd7c1f6d7e438">ipproto</a> = get_ipproto_by_xprt(req-&gt;rq_xprt) ;
<a name="l00557"></a>00557   buffdata.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) pdupreq;
<a name="l00558"></a>00558   buffdata.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(<a class="code" href="nfs__dupreq_8h.html#a28c3f648d84fdac5189e6f4ea11f768e">dupreq_entry_t</a>);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560   <a class="code" href="nfs__dupreq_8c.html#a19a92c1cca2c6d33998dddd4094eef7f">LogDupReq</a>(<span class="stringliteral">&quot;Add Not Finished&quot;</span>, &amp;pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a5b17b67b0d53ad23d5298bff2e689178">addr</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a02e9d24e871412dc20f93c843dd31e1b">xid</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a>);
<a name="l00561"></a>00561 
<a name="l00562"></a>00562   status = <a class="code" href="group__HTExported.html#ga613e404f11079c49c4020b659fe681cd" title="Set a pair (key,value) into the Hash Table.">HashTable_Test_And_Set</a>(ht_dupreq, &amp;buffkey, &amp;buffdata,
<a name="l00563"></a>00563                                   <a class="code" href="group__HTStructs.html#ggab434086e69de04e0dcb4a269625c83e3a160497855cb35a4e7db24152027751cd">HASHTABLE_SET_HOW_SET_NO_OVERWRITE</a>);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565   <span class="keywordflow">if</span> (status == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1adbdb734f513f190d7b52ea69e0a89d13">HASHTABLE_ERROR_KEY_ALREADY_EXISTS</a>)
<a name="l00566"></a>00566     {
<a name="l00567"></a>00567       <span class="keywordflow">if</span>(HashTable_Get(ht_dupreq, &amp;buffkey, &amp;buffval) == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>)
<a name="l00568"></a>00568         {
<a name="l00569"></a>00569           <a class="code" href="common__utils_8h.html#a13190861330e48fe885da6b2671876a9">P</a>(((<a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *)buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>)-&gt;dupreq_mutex);
<a name="l00570"></a>00570           <span class="keywordflow">if</span> ( ((<a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *)buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>)-&gt;processing == 1)
<a name="l00571"></a>00571             {
<a name="l00572"></a>00572               status = <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa98fd422532ebdcd70e7682d3c0aa419c">DUPREQ_BEING_PROCESSED</a>;
<a name="l00573"></a>00573             }
<a name="l00574"></a>00574           <span class="keywordflow">else</span>
<a name="l00575"></a>00575             {
<a name="l00576"></a>00576               *res_nfs = ((<a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *) buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>)-&gt;res_nfs;
<a name="l00577"></a>00577               status = <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa8da646241fbb89f0df17b9458aae381a">DUPREQ_ALREADY_EXISTS</a>;
<a name="l00578"></a>00578             }
<a name="l00579"></a>00579           <a class="code" href="common__utils_8h.html#a5a9b6f8030959507eee365b226d63b00">V</a>(((<a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *)buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>)-&gt;dupreq_mutex);
<a name="l00580"></a>00580         }
<a name="l00581"></a>00581       <span class="keywordflow">else</span>
<a name="l00582"></a>00582         status = <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa5e1858a0b91c975314d7316be31c0bcd">DUPREQ_NOT_FOUND</a>;
<a name="l00583"></a>00583     }
<a name="l00584"></a>00584   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1abdca7ab079852a14f1bd2cf6ca30840a">HASHTABLE_INSERT_MALLOC_ERROR</a>)
<a name="l00585"></a>00585       status = <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faabf8d181a38bfc1ee1a745a9c8b7f5e6d">DUPREQ_INSERT_MALLOC_ERROR</a>;
<a name="l00586"></a>00586   <span class="keywordflow">else</span>
<a name="l00587"></a>00587     status = <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa081a1934d0972db9961d46f25d264ff9">DUPREQ_SUCCESS</a>;
<a name="l00588"></a>00588   <span class="keywordflow">if</span> (status != <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa081a1934d0972db9961d46f25d264ff9">DUPREQ_SUCCESS</a>) {
<a name="l00589"></a>00589     pool_free(<a class="code" href="nfs__core_8h.html#a120af9c25da978b5bec06f8ca0453219">dupreq_pool</a>, pdupreq);
<a name="l00590"></a>00590     gsh_free(pdupkey);
<a name="l00591"></a>00591   }
<a name="l00592"></a>00592   <span class="keywordflow">return</span> status;
<a name="l00593"></a>00593 }                               <span class="comment">/* nfs_dupreq_add_not_finished */</span>
<a name="l00594"></a>00594 
<a name="l00612"></a><a class="code" href="nfs__dupreq_8c.html#aabab915e080d080a9a4cdd0df471044d">00612</a> <span class="keywordtype">int</span> <a class="code" href="nfs__dupreq_8h.html#aabab915e080d080a9a4cdd0df471044d">nfs_dupreq_finish</a>(<span class="keyword">struct</span> svc_req *req, <a class="code" href="unionnfs__res____.html">nfs_res_t</a> *p_res_nfs,
<a name="l00613"></a>00613                       <a class="code" href="structlru__list____.html">LRU_list_t</a> *lru_dupreq)
<a name="l00614"></a>00614 {
<a name="l00615"></a>00615   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffkey;
<a name="l00616"></a>00616   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffval;
<a name="l00617"></a>00617   <a class="code" href="structlru__entry____.html">LRU_entry_t</a> *pentry = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00618"></a>00618   <a class="code" href="LRU__List_8h.html#a311d7eceb3c6397078a27534b3744599">LRU_status_t</a> lru_status;
<a name="l00619"></a>00619   <a class="code" href="structdupreq__key____.html">dupreq_key_t</a> dupkey;
<a name="l00620"></a>00620   <a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *pdupreq;
<a name="l00621"></a>00621   <a class="code" href="structhash__table.html">hash_table_t</a> *ht_dupreq = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623   <span class="comment">/* Get correct HT depending on proto used */</span>
<a name="l00624"></a>00624   ht_dupreq = get_ht_by_xprt(req-&gt;rq_xprt) ;
<a name="l00625"></a>00625  
<a name="l00626"></a>00626 
<a name="l00627"></a>00627   <span class="comment">/* Get the socket address for the key */</span>
<a name="l00628"></a>00628   <span class="keywordflow">if</span>(<a class="code" href="ganesha__rpc_8h.html#ac79de7952a084c98f9dfeba5e1ac0556">copy_xprt_addr</a>(&amp;dupkey.<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>, req-&gt;rq_xprt) == 0)
<a name="l00629"></a>00629     <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa5e1858a0b91c975314d7316be31c0bcd">DUPREQ_NOT_FOUND</a>;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631   dupkey.<a class="code" href="structdupreq__key____.html#aca61acb884341d8130a0b5d27101f42c">xid</a> = req-&gt;rq_xid;
<a name="l00632"></a>00632   dupkey.<a class="code" href="structdupreq__key____.html#a19bcf815511eb6ed35ba6943d512cba7">checksum</a> = 0;
<a name="l00633"></a>00633 
<a name="l00634"></a>00634   <span class="comment">/* I have to keep an integer as key, I wil use the pointer buffkey-&gt;pdata for this,</span>
<a name="l00635"></a>00635 <span class="comment">   * this also means that buffkey-&gt;len will be 0 */</span>
<a name="l00636"></a>00636   buffkey.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) &amp;dupkey;
<a name="l00637"></a>00637   buffkey.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(<a class="code" href="nfs__dupreq_8h.html#a928052411953c17dd2c4c48ecebce48b">dupreq_key_t</a>);
<a name="l00638"></a>00638   <span class="keywordflow">if</span>(HashTable_Get(ht_dupreq, &amp;buffkey, &amp;buffval) != <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>)
<a name="l00639"></a>00639     <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa5e1858a0b91c975314d7316be31c0bcd">DUPREQ_NOT_FOUND</a>;
<a name="l00640"></a>00640 
<a name="l00641"></a>00641   pdupreq = (<a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *)buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00642"></a>00642 
<a name="l00643"></a>00643   <a class="code" href="nfs__dupreq_8c.html#a19a92c1cca2c6d33998dddd4094eef7f">LogDupReq</a>(<span class="stringliteral">&quot;Finish&quot;</span>, &amp;pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a5b17b67b0d53ad23d5298bff2e689178">addr</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a02e9d24e871412dc20f93c843dd31e1b">xid</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a>);
<a name="l00644"></a>00644 
<a name="l00645"></a>00645   <a class="code" href="common__utils_8h.html#a13190861330e48fe885da6b2671876a9">P</a>(pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#aa748a8db7613dddc13e5cddc70bb310f">dupreq_mutex</a>);
<a name="l00646"></a>00646 
<a name="l00647"></a>00647   pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a91759815834de60b78ee4c3d53da76cd">res_nfs</a> = *p_res_nfs;
<a name="l00648"></a>00648   pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a8e4cbe7b4e0224924a8c99cfbdb93d9b">timestamp</a> = time(<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00649"></a>00649   pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#ab25c3db1f9ae861daf4d183a706cd1bf">processing</a> = 0;
<a name="l00650"></a>00650 
<a name="l00651"></a>00651   <a class="code" href="common__utils_8h.html#a5a9b6f8030959507eee365b226d63b00">V</a>(pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#aa748a8db7613dddc13e5cddc70bb310f">dupreq_mutex</a>);
<a name="l00652"></a>00652 
<a name="l00653"></a>00653   <span class="comment">/* Add it to lru list */</span>
<a name="l00654"></a>00654   <span class="keywordflow">if</span>((pentry = <a class="code" href="group__LRUExportedFunctions.html#gac3cdaf55a44b7b59956d18e4f842e313">LRU_new_entry</a>(lru_dupreq, &amp;lru_status)) == <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00655"></a>00655     <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faabf8d181a38bfc1ee1a745a9c8b7f5e6d">DUPREQ_INSERT_MALLOC_ERROR</a>;
<a name="l00656"></a>00656   pentry-&gt;<a class="code" href="structlru__entry____.html#a8c131e4292bf1f64731ee20726902ab4">buffdata</a>.<a class="code" href="structLRU__data____.html#a59f72c5e75d16cabb60c4fdac12421f4">pdata</a> = buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00657"></a>00657   pentry-&gt;<a class="code" href="structlru__entry____.html#a8c131e4292bf1f64731ee20726902ab4">buffdata</a>.<a class="code" href="structLRU__data____.html#a980d385c9e93a60839d4144206f2f084">len</a> = buffval.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a>;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659   <span class="keywordflow">return</span> <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa081a1934d0972db9961d46f25d264ff9">DUPREQ_SUCCESS</a>;
<a name="l00660"></a>00660 }                               <span class="comment">/* nfs_dupreq_finish */</span>
<a name="l00661"></a>00661 
<a name="l00675"></a><a class="code" href="nfs__dupreq_8c.html#a49e397d60fa354b43179f2926daa2256">00675</a> <a class="code" href="unionnfs__res____.html">nfs_res_t</a> <a class="code" href="nfs__dupreq_8h.html#a49e397d60fa354b43179f2926daa2256">nfs_dupreq_get</a>(<span class="keyword">struct</span> svc_req *req, <span class="keywordtype">int</span> *pstatus)
<a name="l00676"></a>00676 {
<a name="l00677"></a>00677   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffkey;
<a name="l00678"></a>00678   <a class="code" href="structhash__buff.html">hash_buffer_t</a> buffval;
<a name="l00679"></a>00679   <a class="code" href="unionnfs__res____.html">nfs_res_t</a> res_nfs;
<a name="l00680"></a>00680   <a class="code" href="structdupreq__key____.html">dupreq_key_t</a> dupkey;
<a name="l00681"></a>00681   <a class="code" href="structhash__table.html">hash_table_t</a> * ht_dupreq = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683   <span class="comment">/* Get correct HT depending on proto used */</span>
<a name="l00684"></a>00684   ht_dupreq = get_ht_by_xprt(req-&gt;rq_xprt) ;
<a name="l00685"></a>00685  
<a name="l00686"></a>00686 
<a name="l00687"></a>00687   memset(&amp;res_nfs, 0, <span class="keyword">sizeof</span>(res_nfs));
<a name="l00688"></a>00688 
<a name="l00689"></a>00689   <span class="comment">/* Get the socket address for the key */</span>
<a name="l00690"></a>00690   <span class="keywordflow">if</span>(<a class="code" href="ganesha__rpc_8h.html#ac79de7952a084c98f9dfeba5e1ac0556">copy_xprt_addr</a>(&amp;dupkey.<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>, req-&gt;rq_xprt) == 0)
<a name="l00691"></a>00691     {
<a name="l00692"></a>00692       *pstatus = <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa5e1858a0b91c975314d7316be31c0bcd">DUPREQ_NOT_FOUND</a>;
<a name="l00693"></a>00693       <span class="keywordflow">return</span> res_nfs;
<a name="l00694"></a>00694     }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696   dupkey.<a class="code" href="structdupreq__key____.html#aca61acb884341d8130a0b5d27101f42c">xid</a> = req-&gt;rq_xid;
<a name="l00697"></a>00697   dupkey.<a class="code" href="structdupreq__key____.html#a19bcf815511eb6ed35ba6943d512cba7">checksum</a> = 0;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699   <span class="comment">/* I have to keep an integer as key, I wil use the pointer buffkey-&gt;pdata for this,</span>
<a name="l00700"></a>00700 <span class="comment">   * this also means that buffkey-&gt;len will be 0 */</span>
<a name="l00701"></a>00701   buffkey.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a> = (caddr_t) &amp;dupkey;
<a name="l00702"></a>00702   buffkey.<a class="code" href="structhash__buff.html#aae02d0ce42b7fda47c6f9a3138fce7b3">len</a> = <span class="keyword">sizeof</span>(<a class="code" href="nfs__dupreq_8h.html#a928052411953c17dd2c4c48ecebce48b">dupreq_key_t</a>);
<a name="l00703"></a>00703   <span class="keywordflow">if</span>(HashTable_Get(ht_dupreq, &amp;buffkey, &amp;buffval) == <a class="code" href="HashTable_8h.html#a0d8b1857db622f6fc6484505310913d1ae64a2488a63ad86c9c51faa790508940">HASHTABLE_SUCCESS</a>)
<a name="l00704"></a>00704     {
<a name="l00705"></a>00705       <a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *pdupreq = (<a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *)buffval.<a class="code" href="structhash__buff.html#a3c326798104545de8aea28c86307299d">pdata</a>;
<a name="l00706"></a>00706       <span class="comment">/* reset timestamp */</span>
<a name="l00707"></a>00707       pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a8e4cbe7b4e0224924a8c99cfbdb93d9b">timestamp</a> = time(<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00708"></a>00708 
<a name="l00709"></a>00709       *pstatus = <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa081a1934d0972db9961d46f25d264ff9">DUPREQ_SUCCESS</a>;
<a name="l00710"></a>00710       res_nfs = pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a91759815834de60b78ee4c3d53da76cd">res_nfs</a>;
<a name="l00711"></a>00711       <a class="code" href="nfs__dupreq_8c.html#a19a92c1cca2c6d33998dddd4094eef7f">LogDupReq</a>(<span class="stringliteral">&quot; dupreq_get: Hit in the dupreq cache for&quot;</span>, &amp;pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a5b17b67b0d53ad23d5298bff2e689178">addr</a>,
<a name="l00712"></a>00712                 pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a02e9d24e871412dc20f93c843dd31e1b">xid</a>, pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a3eba2da8cbd260169725c6372a9229f2">rq_prog</a>);
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714   <span class="keywordflow">else</span>
<a name="l00715"></a>00715     {
<a name="l00716"></a>00716       <a class="code" href="nfs__dupreq_8c.html#a19a92c1cca2c6d33998dddd4094eef7f">LogDupReq</a>(<span class="stringliteral">&quot;Failed to get dupreq entry&quot;</span>, &amp;dupkey.<a class="code" href="structdupreq__key____.html#a665a91114bd9c3179b5cfd1b7f5d1d44">addr</a>, dupkey.<a class="code" href="structdupreq__key____.html#aca61acb884341d8130a0b5d27101f42c">xid</a>, req-&gt;rq_prog);
<a name="l00717"></a>00717       *pstatus = <a class="code" href="nfs__dupreq_8h.html#a8f699cea0366b683501fe91a4dbc37faa5e1858a0b91c975314d7316be31c0bcd">DUPREQ_NOT_FOUND</a>;
<a name="l00718"></a>00718     }
<a name="l00719"></a>00719   <span class="keywordflow">return</span> res_nfs;
<a name="l00720"></a>00720 }                               <span class="comment">/* nfs_dupreq_get */</span>
<a name="l00721"></a>00721 
<a name="l00736"></a><a class="code" href="nfs__dupreq_8c.html#a35d644f1f1b2c333ddc223251d615205">00736</a> <span class="keywordtype">int</span> <a class="code" href="nfs__dupreq_8h.html#a35d644f1f1b2c333ddc223251d615205">nfs_dupreq_gc_function</a>(<a class="code" href="structlru__entry____.html">LRU_entry_t</a> * pentry, <span class="keywordtype">void</span> *addparam)
<a name="l00737"></a>00737 {
<a name="l00738"></a>00738   <a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *pdupreq = <a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740   pdupreq = (<a class="code" href="structdupreq__entry____.html">dupreq_entry_t</a> *) (pentry-&gt;<a class="code" href="structlru__entry____.html#a8c131e4292bf1f64731ee20726902ab4">buffdata</a>.<a class="code" href="structLRU__data____.html#a59f72c5e75d16cabb60c4fdac12421f4">pdata</a>);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742   <span class="comment">/* Test if entry is expired */</span>
<a name="l00743"></a>00743   <span class="keywordflow">if</span>(time(<a class="code" href="Getopt_8c.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) - pdupreq-&gt;<a class="code" href="structdupreq__entry____.html#a8e4cbe7b4e0224924a8c99cfbdb93d9b">timestamp</a> &gt; <a class="code" href="nfs__core_8h.html#aeb8fc46586993cf210777049fca03969">nfs_param</a>.<a class="code" href="structnfs__param____.html#aeef2995e9b54747311db1972d158fd41">core_param</a>.<a class="code" href="structnfs__core__param____.html#afe5dc76bdf5fa31ad5778dca3a9faf8d">expiration_dupreq</a>)
<a name="l00744"></a>00744     <span class="keywordflow">return</span> <a class="code" href="LRU__List_8h.html#a16c72281b598d50ac5bb9150db17ce53">LRU_LIST_SET_INVALID</a>;
<a name="l00745"></a>00745 
<a name="l00746"></a>00746   <span class="keywordflow">return</span> <a class="code" href="LRU__List_8h.html#a5b1528d9b7c404d5743cf5a06956400a">LRU_LIST_DO_NOT_SET_INVALID</a>;
<a name="l00747"></a>00747 }                               <span class="comment">/* nfs_dupreq_fc_function */</span>
<a name="l00748"></a>00748 
<a name="l00762"></a><a class="code" href="nfs__dupreq_8c.html#ad36745bd28b69a188cd5092a390a3ca2">00762</a> <span class="keywordtype">void</span> <a class="code" href="nfs__dupreq_8h.html#ad36745bd28b69a188cd5092a390a3ca2">nfs_dupreq_get_stats</a>(<a class="code" href="structhash__stat.html">hash_stat_t</a> * phstat_udp, <a class="code" href="structhash__stat.html">hash_stat_t</a> * phstat_tcp )
<a name="l00763"></a>00763 {
<a name="l00764"></a>00764   <a class="code" href="group__HTExported.html#gab876ef4cbcedd8049233ed0026cc2ac2" title="Get information on the hash table.">HashTable_GetStats</a>(ht_dupreq_udp, phstat_udp);
<a name="l00765"></a>00765   <a class="code" href="group__HTExported.html#gab876ef4cbcedd8049233ed0026cc2ac2" title="Get information on the hash table.">HashTable_GetStats</a>(ht_dupreq_tcp, phstat_tcp);
<a name="l00766"></a>00766 }                               <span class="comment">/* nfs_dupreq_get_stats */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Nov 21 2012 for nfs-ganesha by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
